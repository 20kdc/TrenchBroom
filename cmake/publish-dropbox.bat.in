@ECHO OFF

if "%~1"=="" (
  ECHO You must supply the git commit id of the last published build for this platform.
  EXIT /B 1
)

cmake -G "@CMAKE_GENERATOR@" "@CMAKE_SOURCE_DIR@"
cmake --build . --config Release

cd Release
TrenchBroom-Test
IF ERRORLEVEL 1 GOTO error
cd ..

cmake --build . --config Release --target package
cmake --build . --config Release --target publish
call generate-changelog.bat %1

GOTO end

:error
cd ..
ECHO Unit tests failed, aborting build.
EXIT /B 1

:end
